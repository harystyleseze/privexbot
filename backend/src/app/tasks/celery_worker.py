"""
Celery Worker Configuration - Main Celery app instance.

WHY:
- Async task processing for long-running operations
- Background jobs for KB processing, crawling, embeddings
- Scheduled tasks for maintenance

HOW:
- Celery app with Redis broker
- Auto-discover tasks from app.tasks
- Result backend for tracking
- Task queues: high_priority, default, low_priority
- Scheduled tasks with Celery Beat
"""

from celery import Celery
from celery.schedules import crontab
from app.core.config import settings

# Create Celery app instance
celery_app = Celery(
    "privexbot",
    broker=settings.CELERY_BROKER_URL,
    backend=settings.CELERY_RESULT_BACKEND
)

# Celery configuration
celery_app.conf.update(
    task_serializer="json",
    accept_content=["json"],
    result_serializer="json",
    timezone="UTC",
    enable_utc=True,

    # Task result expiration
    result_expires=3600,

    # Task execution settings
    task_acks_late=True,
    task_reject_on_worker_lost=True,

    # Worker settings
    worker_prefetch_multiplier=1,
    worker_max_tasks_per_child=100,

    # Task routing with multiple queues
    task_default_queue="default",
    task_default_exchange="default",
    task_default_routing_key="default",

    # Define task routes (route tasks to specific queues)
    task_routes={
        # High priority queue
        "app.tasks.kb_pipeline_tasks.process_web_kb": {"queue": "high_priority"},
        "app.tasks.kb_pipeline_tasks.reindex_kb": {"queue": "high_priority"},

        # Low priority queue
        "app.tasks.kb_maintenance_tasks.*": {"queue": "low_priority"},
    },

    # Scheduled tasks (Celery Beat)
    beat_schedule={
        # Clean up expired pipeline tracking data every hour
        "cleanup-expired-pipelines": {
            "task": "app.tasks.kb_maintenance_tasks.cleanup_expired_pipelines",
            "schedule": crontab(minute=0),  # Every hour
        },

        # Re-index stale KBs every day at 2 AM
        "reindex-stale-kbs": {
            "task": "app.tasks.kb_maintenance_tasks.reindex_stale_kbs",
            "schedule": crontab(hour=2, minute=0),  # Daily at 2 AM
        },

        # Health check for Qdrant collections every 6 hours
        "health-check-qdrant": {
            "task": "app.tasks.kb_maintenance_tasks.health_check_qdrant_collections",
            "schedule": crontab(minute=0, hour="*/6"),  # Every 6 hours
        },
    },
)

# Auto-discover tasks from app.tasks module
celery_app.autodiscover_tasks(["app.tasks"])
